<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>주민들과 대화</title>
<link href="https://fonts.googleapis.com/css2?family=Orbit:wght@400&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{
  width:100vw;height:100vh;
  overflow:hidden;
  font-family:"Orbit";
  cursor:none;
  position:relative;
  perspective:1000px;
}

/* 배경 이미지 - 흔들림 효과 */
#bg-image{
  position:fixed;
  inset:0;
  background:url('town.png') center/cover no-repeat;
  background-size:110% 110%;
  z-index:0;
  animation:cameraShake 4s ease-in-out infinite;
}

/* 검은 오버레이 - 눈을 뜨는 것처럼 페이드아웃 */
#black-overlay{
  position:fixed;
  inset:0;
  background:#000;
  z-index:1000;
  pointer-events:none;
  animation:fadeOutEyes 2s ease-out forwards;
}

@keyframes fadeOutEyes{
  0%{opacity:1;}
  100%{opacity:0;}
}

/* 챕터 표시 */
#chapter-label{
  position:fixed;
  top:30px;
  left:50%;
  transform:translateX(-50%);
  color:white;
  font-size:1.2rem;
  font-weight:bold;
  font-family:"Orbit", sans-serif;
  z-index:200;
  text-shadow:0 2px 10px rgba(0,0,0,0.5);
  letter-spacing:3px;
}

/* 프레임 이미지 */
#web-frame{
  position:fixed;
  inset:0;
  width:100vw;
  height:100vh;
  object-fit:cover;
  z-index:9999;
  pointer-events:none;
}

/* 윈도우 노이즈 효과 */
#window-noise{
  position:fixed;
  inset:0;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
  opacity:0.15;
  pointer-events:none;
  z-index:10000;
  mix-blend-mode:overlay;
  animation:noiseFlicker 0.1s infinite;
}

@keyframes noiseFlicker{
  0%,100%{opacity:0.1;}
  50%{opacity:0.2;}
}

/* 스캔라인 효과 */
#scanlines{
  position:fixed;
  inset:0;
  background:repeating-linear-gradient(
    0deg,
    transparent 0px,
    transparent 2px,
    rgba(0,0,0,0.1) 2px,
    rgba(0,0,0,0.1) 4px
  );
  pointer-events:none;
  z-index:10001;
}

/* 파란 Error 화면 오버레이 */
#error-overlay{
  position:fixed;
  inset:0;
  background:#0000aa;
  opacity:0.4;
  z-index:1;
  pointer-events:none;
  transition:opacity 0.5s;
}

/* 스피커 라벨 */
#speaker-label{
  position:fixed;
  bottom:180px;
  left:50%;
  transform:translateX(-50%);
  margin-left:-280px;
  background:rgba(0,0,100,0.85);
  color:white;
  padding:8px 16px;
  border-radius:8px;
  font-size:0.9rem;
  font-weight:bold;
  text-transform:uppercase;
  z-index:100;
  pointer-events:none;
  font-family:"Orbit", sans-serif;
  opacity:0;
  transition:opacity 0.3s;
}

#speaker-label.show{opacity:1;}

/* 자막바 */
#subtitle-box{
  position:fixed;
  bottom:60px;
  left:50%;
  transform:translateX(-50%);
  width:600px;
  max-width:90%;
  background:rgba(0,0,0,0.6);
  padding:20px 30px;
  z-index:100;
  cursor:pointer;
  transition:background 0.3s;
  min-height:80px;
  display:flex;
  align-items:center;
  border-radius:10px;
  backdrop-filter:blur(5px);
  opacity:0;
  pointer-events:none;
}

#subtitle-box.show{
  opacity:1;
  pointer-events:auto;
}

#subtitle-box:hover{
  background:rgba(0,0,0,0.75);
}

#subtitle-text{
  color:white;
  font-size:1.1rem;
  line-height:1.6;
  font-family:"Orbit", sans-serif;
  width:100%;
  max-width:90%;
}

/* 타이핑 커서 */
#typing-cursor{
  display:inline-block;
  width:2px;
  height:1.2em;
  background:white;
  margin-left:4px;
  animation:blinkCursor 1s infinite;
  vertical-align:middle;
}

@keyframes blinkCursor{
  0%,50%{opacity:1;}
  51%,100%{opacity:0;}
}

/* 대화 화면 */
#dialogue-scene{
  position:fixed;
  inset:0;
  z-index:100;
  opacity:0;
  pointer-events:none;
  transition:opacity 0.5s;
}

#dialogue-scene.show{
  opacity:1;
  pointer-events:auto;
}

/* 대화 화면 배경 */
#dialogue-bg{
  position:fixed;
  inset:0;
  background:url('talk.png') center/cover no-repeat;
  z-index:99;
}

/* 대화 인물 - 대화창 윗부분에 딱 붙게 */
#dialogue-person{
  position:fixed;
  bottom:300px;
  right:0%;
  width:1000px;
  height:auto;
  max-height:95vh;
  z-index:100;
  object-fit:contain;
  object-position:center bottom;
  transform:translateX(20%);
}

/* 스피커 이름 */
#dialogue-speaker{
  position:fixed;
  bottom:140px;
  left:5%;
  background:rgba(70,130,200,0.9);
  color:white;
  padding:10px 20px;
  border-radius:8px;
  font-size:1rem;
  font-weight:bold;
  z-index:102;
  font-family:"Orbit", sans-serif;
}

/* 대화 텍스트 박스 */
#dialogue-subtitle{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  height:300px;
  background:linear-gradient(180deg, rgb(255, 255, 255) 0%, #9e9cff 50%, #4a47ff 100%);
  z-index:102;
  display:flex;
  align-items:center;
  justify-content:flex-start;
  padding:20px 40px;
  padding-left:5%;
}

#dialogue-text{
  color:#000;
  font-size:1.2rem;
  line-height:1.6;
  text-align:left;
  max-width:60%;
  font-family:"Orbit", sans-serif;
}

/* 주민 목록 */
#residents-container{
  position:fixed;
  inset:0;
  z-index:1;
  pointer-events:none;
  opacity:0.5;
  transition:opacity 0.5s, pointer-events 0.5s;
}

#residents-container.active{
  pointer-events:auto;
  opacity:1;
}

.resident{
  position:absolute;
  width:250px;
  height:auto;
  cursor:pointer;
  transition:filter 0.3s;
  pointer-events:auto;
  z-index:2;
  filter:blur(2px);
}

.resident:hover{
  filter:blur(1px) brightness(1.1);
}

.speech-bubble{
  position:absolute;
  bottom:220px;
  left:50%;
  transform:translateX(-50%);
  background:white;
  padding:15px 20px;
  border-radius:15px;
  max-width:250px;
  font-size:0.9rem;
  color:#333;
  opacity:0;
  pointer-events:none;
  box-shadow:0 5px 15px rgba(0,0,0,0.2);
  transition:opacity 0.3s;
}

.speech-bubble::after{
  content:"";
  position:absolute;
  bottom:-10px;
  left:50%;
  transform:translateX(-50%);
  border:10px solid transparent;
  border-top-color:white;
}

.speech-bubble.show{
  opacity:1;
  pointer-events:auto;
}

/* 하단 힌트 */
#hint{
  position:fixed;
  bottom:30px;left:50%;
  transform:translateX(-50%);
  color:#666;
  font-size:0.85rem;
  z-index:10;
  opacity:0.7;
}

/* 마우스 점 */
#cursor-dot{
  position:fixed;
  width:14px;height:14px;
  border-radius:50%;
  border:2px solid rgba(0,0,0,0.6);
  transform:translate(-50%,-50%);
  pointer-events:none;
  z-index:9999;
}

/* 커서 집 아이콘 */
#home-container{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:1000;
}

.home{
  position:absolute;
  width:100px;
  pointer-events:none;
  mix-blend-mode:screen;
  opacity:0.8;
  transition:transform 0.1s ease-out, opacity 0.5s ease-out;
  will-change:transform;
  z-index:1000;
}

/* 상단 힌트 */
#top-hint{
  position:fixed;
  top:30px;
  left:50%;
  transform:translateX(-50%);
  color:white;
  font-size:1rem;
  z-index:50;
  opacity:0;
  pointer-events:none;
  background:rgba(0,0,0,0.6);
  padding:10px 20px;
  border-radius:20px;
  backdrop-filter:blur(5px);
  transition:opacity 0.5s;
}

#top-hint.show{
  opacity:1;
  pointer-events:auto;
}

/* 카메라 흔들림 */
@keyframes cameraShake{
  0%{transform:translateX(0px);}
  25%{transform:translateX(-2px);}
  50%{transform:translateX(0px);}
  75%{transform:translateX(2px);}
  100%{transform:translateX(0px);}
}

/* 주민 이미지 흔들림 */
.resident img{
  width:100%;
  height:auto;
  display:block;
  filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3));
  animation:cameraShake 4s ease-in-out infinite;
}

/* 비네트 효과 */
#vignette{
  position:fixed;
  inset:0;
  background:radial-gradient(ellipse at center, transparent 0%, transparent 60%, rgba(0,0,0,0.4) 100%);
  pointer-events:none;
  z-index:200;
}
</style>
</head>
<body>

<img id="web-frame" src="web frame.png" alt="frame">
<div id="window-noise"></div>
<div id="scanlines"></div>
<div id="chapter-label">CHAPTER 2</div>
<div id="bg-image"></div>
<div id="black-overlay"></div>
<div id="error-overlay"></div>
<div id="vignette"></div>

<div id="speaker-label">YOU</div>
<div id="subtitle-box">
  <div id="subtitle-text"></div>
</div>

<div id="residents-container">
  <div class="resident" data-dialogue="어디서 오셨어요?" style="left:23%; top:30%; width:220px;">
    <img src="people1.png" alt="주민">
  </div>
  
  <div class="resident" data-dialogue="금방 적응하실 거예요." style="right:13%; top:40%; width:350px;">
    <img src="people2.png" alt="주민">
  </div>
  
  <div class="resident" data-dialogue="여긴 조용해서 좋아요. 그렇죠?" style="right:15%; top:20%; width:150px;">
    <img src="people3.png" alt="주민">
  </div>
</div>

<div id="home-container"></div>
<div id="top-hint">주민들을 클릭해보세요</div>
<div id="hint">주민들을 클릭해보세요</div>
<div id="cursor-dot"></div>

<!-- 대화 화면 -->
<div id="dialogue-scene">
  <div id="dialogue-bg"></div>
  <img id="dialogue-person" src="" alt="주민">
  <div id="dialogue-speaker">주민 1</div>
  <div id="dialogue-subtitle">
    <div id="dialogue-text"></div>
  </div>
</div>

<script>
const residents = document.querySelectorAll(".resident");
const cursor = document.getElementById("cursor-dot");
const dialogueScene = document.getElementById("dialogue-scene");
const dialogueText = document.getElementById("dialogue-text");
const dialoguePerson = document.getElementById("dialogue-person");
const dialogueSpeaker = document.getElementById("dialogue-speaker");
const residentsContainer = document.getElementById("residents-container");
const hint = document.getElementById("hint");
const subtitleBox = document.getElementById("subtitle-box");
const subtitleText = document.getElementById("subtitle-text");
const speakerLabel = document.getElementById("speaker-label");
const topHint = document.getElementById("top-hint");
const homeContainer = document.getElementById("home-container");
const errorOverlay = document.getElementById("error-overlay");

// 주민별 대화 내용
const dialogues = {
  0: [
    "어디서 오셨어요?",
    "옆집 사는 사람인데~ 앞으로 잘 지내봐요.",
    "이사 준비하느라 고생하셨을텐데, 이것 좀 먹으면서 쉬세요~.",
    "(선물까지 받아버렸다...)"
  ],
  1: [
    "못 보던 얼굴인데 이사오셨나봐요?",
    "적응하느라 힘들죠? 금방 익숙해지실 거예요~.",
    "도서관이나 이곳저곳 궁금하신 곳 있으면 알려드릴테니까 부담갖지말고 물어보셔도 돼요."
  ],
  2: [
    "기차역이 어딘지 찾고 계시군요.",
    "여기서 한 블럭 간 후에 왼 쪽으로 꺾고 그러고 두 블럭 더 가서 오른쪽으로 돌아가시면 기차역이 나올거예요!",
    "오른 쪽으로 꺾어서 파란간판이 나오는 방향이 기차역이니까 잘 기억해두고 찾아가시면 될 것 같아요!"
  ]
};

// 주민별 이름
const speakerNames = {
  0: "주민 1",
  1: "주민 2",
  2: "주민 3"
};

// 초기 메시지
const introMessages = [
  "아파트 단지를 벗어나, 드디어 거리로 들어섰다.",
  "새로운 이웃들인가? 말을 걸어오려는 것 같은데..?"
];

let dialogueIndex = 0;
let isInDialogue = false;
let introMessageIndex = 0;
let isTyping = false;
let typingTimeout = null;
let canClickResidents = false;
let currentDialogueIndex = 0;
let currentResidentIndex = -1;
let isDialogueTyping = false;
let dialogueTypingTimeout = null;

// 집 아이콘 따라오기
const homeImgs = ['home2.png', 'home.png'];
let lastCreateTime = 0;

function createHomeImage(x, y){
  const img = document.createElement('img');
  img.src = homeImgs[Math.floor(Math.random() * homeImgs.length)];
  img.className = 'home';
  img.style.left = x + 'px';
  img.style.top = y + 'px';

  if(Math.random() > 0.5){
    img.style.width = '80px';
    img.style.opacity = '0.6';
    img.style.filter = 'blur(1.5px)';
  }

  homeContainer.appendChild(img);

  setTimeout(() => {
    img.style.opacity = 0;
    setTimeout(() => img.remove(), 500);
  }, 800);
}

document.addEventListener("mousemove", e => {
  cursor.style.left = e.clientX + "px";
  cursor.style.top = e.clientY + "px";
  
  // 집 이미지 생성
  const now = Date.now();
  if(now - lastCreateTime > 50){
    createHomeImage(e.clientX, e.clientY);
    lastCreateTime = now;
  }
});

// 타이핑 효과
function typeText(text, callback){
  if(isTyping) return;
  isTyping = true;
  
  subtitleText.innerHTML = "";
  let charIndex = 0;
  
  function typeChar(){
    if(charIndex < text.length){
      subtitleText.innerHTML = text.substring(0, charIndex + 1) + '<span id="typing-cursor"></span>';
      charIndex++;
      typingTimeout = setTimeout(typeChar, 50);
    } else {
      subtitleText.innerHTML = text;
      isTyping = false;
      if(callback) callback();
    }
  }
  
  typeChar();
}

// 초기 메시지 표시
setTimeout(() => {
  speakerLabel.classList.add("show");
  subtitleBox.classList.add("show");
  typeText(introMessages[0]);
}, 2100); // 검은 오버레이가 사라진 후

// 자막바 클릭 이벤트
subtitleBox.addEventListener("click", () => {
  if(isTyping){
    // 타이핑 중이면 즉시 완성
    clearTimeout(typingTimeout);
    subtitleText.innerHTML = introMessages[introMessageIndex];
    isTyping = false;
    return;
  }
  
  introMessageIndex++;
  
  if(introMessageIndex < introMessages.length){
    // 다음 메시지 타이핑
    typeText(introMessages[introMessageIndex]);
  } else {
    // 초기 메시지 끝, 주민들 클릭 가능하게
    subtitleBox.style.opacity = "0";
    speakerLabel.style.opacity = "0";
    errorOverlay.style.opacity = "0";
    setTimeout(() => {
      subtitleBox.style.pointerEvents = "none";
      speakerLabel.style.pointerEvents = "none";
      canClickResidents = true;
      residentsContainer.classList.add("active");
      hint.style.opacity = "0.7";
      topHint.classList.add("show");
    }, 300);
  }
});

residents.forEach((resident, index) => {
  const bubble = resident.querySelector(".speech-bubble");
  
  resident.addEventListener("click", () => {
    if(isInDialogue || !canClickResidents) return;
    
    topHint.style.opacity = "0";
    hint.style.opacity = "0";
    
    // 클릭한 주민의 이미지 설정 (talk 버전 사용)
    const clickedImg = resident.querySelector("img").src;
    // people1.png -> people1talk.png로 변경
    const talkImg = clickedImg.replace('.png', 'talk.png');
    dialoguePerson.src = talkImg;
    
    // 스피커 이름 설정
    dialogueSpeaker.textContent = speakerNames[index] || "주민 1";
    
    // 현재 주민 인덱스와 대화 인덱스 초기화
    currentResidentIndex = index;
    currentDialogueIndex = 0;
    
    // 대화 화면 표시
    setTimeout(() => {
      dialogueScene.classList.add("show");
      isInDialogue = true;
      
      // 첫 번째 대화 표시
      const residentDialogues = dialogues[index] || dialogues[0];
      const firstMessage = Array.isArray(residentDialogues) ? residentDialogues[0] : residentDialogues;
      setTimeout(() => {
        typeDialogue(firstMessage);
      }, 300);
    }, 300);
    
    // 클릭 이벤트 핸들러 (한 번만 등록)
    if(!dialogueScene.hasAttribute('data-listener-added')){
      dialogueScene.setAttribute('data-listener-added', 'true');
      dialogueScene.addEventListener("click", function nextDialogue(){
        // 타이핑 중이면 즉시 완성
        if(isDialogueTyping){
          clearTimeout(dialogueTypingTimeout);
          const residentDialogues = dialogues[currentResidentIndex] || dialogues[0];
          const dialogueArray = Array.isArray(residentDialogues) ? residentDialogues : [residentDialogues];
          dialogueText.textContent = dialogueArray[currentDialogueIndex];
          isDialogueTyping = false;
          return;
        }
        
        const residentDialogues = dialogues[currentResidentIndex] || dialogues[0];
        const dialogueArray = Array.isArray(residentDialogues) ? residentDialogues : [residentDialogues];
        
        currentDialogueIndex++;
        
        if(currentDialogueIndex < dialogueArray.length){
          // 다음 대화 표시
          typeDialogue(dialogueArray[currentDialogueIndex]);
        } else {
          // 현재 주민의 모든 대화 끝
          dialogueScene.classList.remove("show");
          dialogueIndex++;
          
          if(dialogueIndex < residents.length){
            setTimeout(() => {
              residentsContainer.style.opacity = "1";
              hint.style.opacity = "0.7";
              isInDialogue = false;
              currentResidentIndex = -1;
              currentDialogueIndex = 0;
            }, 500);
          } else {
            // 모든 대화 끝 - 텍스트박스 다시 표시
            setTimeout(() => {
              residentsContainer.style.opacity = "0";
              hint.style.opacity = "0";
              topHint.style.opacity = "0";
              speakerLabel.style.opacity = "1";
              subtitleBox.style.opacity = "1";
              subtitleBox.style.pointerEvents = "auto";
              speakerLabel.style.pointerEvents = "auto";
              
              // "다들 생각보다 다정하네.." 타이핑
              introMessageIndex = 0;
              isTyping = false;
              typeText("다들 생각보다 다정하네..", () => {
                // 타이핑 완료 후 doors.html로 이동
                setTimeout(() => {
                  location.href = "doors.html";
                }, 2000);
              });
            }, 500);
          }
        }
      });
    }
  });
  
  resident.addEventListener("mouseenter", () => {
    if(!isInDialogue) bubble.classList.add("show");
  });
  
  resident.addEventListener("mouseleave", () => {
    bubble.classList.remove("show");
  });
});

// 타이핑 효과
function typeDialogue(text){
  if(isDialogueTyping) return;
  isDialogueTyping = true;
  
  dialogueText.textContent = "";
  let charIndex = 0;
  
  function typeChar(){
    if(charIndex < text.length){
      dialogueText.textContent = text.substring(0, charIndex + 1);
      charIndex++;
      dialogueTypingTimeout = setTimeout(typeChar, 50);
    } else {
      isDialogueTyping = false;
    }
  }
  
  typeChar();
}
</script>

</body>
</html>
